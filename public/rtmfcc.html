<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>mfcc</title>
  </head>
  <body>

    <script type="text/javascript" src="tmp.js"></script>
    <script>
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      const context = new AudioContext();
      let audioBuffer = null;

      var processor = context.createScriptProcessor(1024, 1, 1);
      processor.onaudioprocess = rtmfccProcess;
      processor.connect(context.destination);

      var bf = context.createBiquadFilter();
      bf.type = 'lowpass';
      bf.frequency.value = 2048;
      bf.connect(processor);

      // for wasm
      let module;

      navigator.mediaDevices.getUserMedia({
        audio: true,
        video: false,
      }).then(function(stream) {
        var input = context.createMediaStreamSource(stream);
        input.connect(bf);
      }).catch(function(err) {
        console.log(err.name + ": " + err.message);
      });

      function rtmfccProcess(e) {
        var inputBuffer = e.inputBuffer;
        var outputBuffer = e.outputBuffer;
        var inputData = inputBuffer.getChannelData(0) || [];
        // var outputData = outputBuffer.getChannelData(0);

        var sampleRate = context.sampleRate;
        var len = inputBuffer.length
        var t = _range(0.0, len / sampleRate, 1 / sampleRate);

        var center = len / 2;
        var cuttime = 0.04;
        // var wav = audioBuffer.getChannelData(0);
        var wavdata = inputData.slice(center - cuttime/2*sampleRate, center + cuttime/2*sampleRate);
        var time = t.slice(center - cuttime/2*sampleRate, center + cuttime/2*sampleRate);

        // call c++ function
        var pointer = module._malloc(wavdata.length * 4)  // Float32Array
        var offset = pointer / 4;
        module.HEAPF32.set(wavdata, offset);
        module.ccall('mfcc', null, ['number', 'number'], [pointer, wavdata.length]);
        module._free(pointer);
      }

      function _range(start, stop, step = 1) {
        var index = 0;
        var length = (stop - start) / step;
        var result = Array(length);

        while(length) {
          result[index] = start;
          start += step;
          index += 1;
          length -= 1;
        }

        return result;
      }

      function fetchWasm(url) {
        fetch(url)
          .then(response => response.arrayBuffer())
          .then(buffer => new Uint8Array(buffer))
          .then(binary => {
            var moduleArgs = {
              wasmBinary: binary
            }
            module = Module(moduleArgs);
          });
      }

      module = fetchWasm('tmp.wasm');
    </script>
  </body>
</html>
