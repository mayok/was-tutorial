<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>mfcc</title>
  </head>
  <body>
    <input type="file" id="files" name="files[]" />
    <button class='btn'>run mfcc</button>

    <script async type="text/javascript" src="tmp.js"></script>
    <script>
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      const context = new AudioContext();
      let audioBuffer = null;

      function fileHandler() {
        const file = event.target.files[0];

        if (!file.type.match('audio.*')) {
          console.error('please upload audio file');
          return;
        }

        const reader = new FileReader();
        reader.onload = ((theFile) => {
          return (e) => {
            context.decodeAudioData(e.target.result, (buffer) => {
              audioBuffer = buffer;
            }, function() {
              console.log('error');
            });
          };
        })(file);

        reader.readAsArrayBuffer(file);
      }

      function _range(start, stop, step = 1) {
        var index = 0;
        var length = (stop - start) / step;
        var result = Array(length);

        while(length) {
          result[index] = start;
          start += step;
          index += 1;
          length -= 1;
        }

        return result;
      }

      function main() {
        var sampleRate = context.sampleRate;
        var len = 8192;
        var t = _range(0.0, len / sampleRate, 1 / sampleRate);

        var center = len / 2;
        var cuttime = 0.04;
        var wav = audioBuffer.getChannelData(0);
        var wavdata = wav.slice(center - cuttime/2*sampleRate, center + cuttime/2*sampleRate);
        var time = t.slice(center - cuttime/2*sampleRate, center + cuttime/2*sampleRate);

        var owavdata = wavdata.slice();

        // pre-emphasis filter
        // var pwavdata = preEmphasis(wavdata, 0.97);
        var result = Module.ccall('preEmphasis', 'array', ['array', 'number'], [Array.from(wavdata), 0.97]);
        console.log(result);
      }

      document.querySelector('.btn').addEventListener('click', main, false);
      document.getElementById('files').addEventListener('change', fileHandler, false);
    </script>
  </body>
</html>
